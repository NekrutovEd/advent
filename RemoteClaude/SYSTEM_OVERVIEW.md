# RemoteClaude — Описание системы

## Назначение

RemoteClaude позволяет управлять агентами Claude Code прямо со смартфона:

- **Наблюдать** за запущенными сессиями в реальном времени
- **Отвечать** на вопросы агентов (ввод, y/n, разрешение инструментов)
- **Запускать** новые агенты на нужных проектах с нужным промптом
- **Оркестровать** несколько агентов параллельно и следить за ними в дашборде
- **Получать уведомления** когда агент ждёт ответа, а приложение свёрнуто

---

## Компоненты системы

```
┌──────────────────────────────────────────────────────────────────┐
│  КОМПЬЮТЕР (Android Studio)                                       │
│                                                                   │
│   ┌─────────────────────────────────────────────────────────┐    │
│   │  Terminal Tab 1  │  Terminal Tab 2  │  Terminal Tab N   │    │
│   │  [Claude Code]   │  [Claude Code]   │  [Claude Code]   │    │
│   └────────┬─────────┴────────┬─────────┴────────┬──────────┘    │
│            │  IntelliJ        │  Terminal API     │               │
│   ┌────────▼─────────────────▼─────────────────▼──────────┐    │
│   │            ПЛАГИН RemoteClaude                          │    │
│   │                                                         │    │
│   │  • Читает вывод всех терминалов                        │    │
│   │  • Принимает ввод от телефона                          │    │
│   │  • Запускает новые агенты по команде с телефона        │    │
│   │  • Запускает batch claude --print задачи               │    │
│   │  • Встроенный Ktor WebSocket сервер (:8765)            │    │
│   │  • mDNS: анонсирует "_claudemobile._tcp"               │    │
│   │  • Tool Window: статус, QR-код, список клиентов        │    │
│   │  • Слушает Claude Code hooks (Notification)            │    │
│   │  • Шлёт FCM/ntfy push при необходимости               │    │
│   └────────────────────────┬────────────────────────────────┘    │
│                             │  WebSocket (ws://)                  │
└─────────────────────────────│────────────────────────────────────┘
                              │
                           WiFi (локальная сеть)
                              │
┌─────────────────────────────│────────────────────────────────────┐
│  СМАРТФОН                   │                                     │
│                             │                                     │
│   ┌─────────────────────────▼──────────────────────────────┐    │
│   │            Android App (KMP)                            │    │
│   │                                                         │    │
│   │  ┌──────────────────────────────────────────────────┐  │    │
│   │  │ ДАШБОРД АГЕНТОВ                    [+Новый]     │  │    │
│   │  │ 🟢 myapp/claude  Running  [Открыть][Стоп]      │  │    │
│   │  │ 🟡 backend/claude Ждёт   [Да][Нет][Открыть]    │  │    │
│   │  │ ⚪ frontend/batch Done   [Результат]            │  │    │
│   │  ├──────────────────────────────────────────────────┤  │    │
│   │  │  Tab 1  │  Tab 2 ●  │  Tab 3                    │  │    │
│   │  ├──────────────────────────────────────────────────┤  │    │
│   │  │   ТЕРМИНАЛ (xterm.js / Compose Canvas)           │  │    │
│   │  │   — реалтайм вывод, ANSI цвета, прокрутка        │  │    │
│   │  ├──────────────────────────────────────────────────┤  │    │
│   │  │  [ поле ввода              ] [Отправить]         │  │    │
│   │  └──────────────────────────────────────────────────┘  │    │
│   │                                                         │    │
│   │  • mDNS autodiscovery или ручной ввод IP               │    │
│   │  • Подключение одним нажатием                          │    │
│   │  • Запуск агентов: выбор проекта + промпт + режим      │    │
│   └─────────────────────────────────────────────────────────┘    │
│                                                                   │
│   ┌─────────────────────────────────────────────────────────┐    │
│   │  Push-уведомление (когда приложение свёрнуто)           │    │
│   │  "Claude ждёт ответа в Tab 2"  [Открыть] [Ответить]    │    │
│   └─────────────────────────────────────────────────────────┘    │
└──────────────────────────────────────────────────────────────────┘
```

---

## Поток данных

### Реалтайм вывод терминала

```
Claude Code печатает в PTY
  → IntelliJ TerminalSession получает вывод
  → Плагин перехватывает через ProcessOutput listener
  → Плагин шлёт WebSocket фрейм: { type: "output", tab: 1, data: "...ansi..." }
  → Android App получает фрейм
  → Передаёт data в xterm.js (write) или Compose Canvas рендерер
  → Пользователь видит вывод в реальном времени
```

### Ввод от пользователя

```
Пользователь набирает текст в поле ввода на телефоне
  → Android App шлёт WebSocket фрейм: { type: "input", tab: 1, data: "y\n" }
  → Плагин получает фрейм
  → Пишет data в stdin терминальной сессии (TerminalSession.sendString)
  → Claude Code получает ввод и продолжает работу
```

### Уведомление о необходимости участия человека

```
Путь 1 — Hooks (надёжный):
  Claude Code вызывает Notification hook
  → ~/.claude/settings.json hook выполняет скрипт
  → Скрипт шлёт HTTP на плагин: POST /api/notify { tab: 1, message: "..." }
  → Плагин проверяет: приложение подключено и активно?
      Да → WebSocket фрейм { type: "notification", ... }
      Нет → FCM / ntfy push уведомление

Путь 2 — Pattern matching (fallback):
  Плагин анализирует каждый output фрейм
  → Ищет паттерны: "❯", "(y/n)", "Allow", "Human turn", "Do you want to"
  → Если найдено — помечает вкладку как "ждёт ввода"
  → Уведомляет телефон (WebSocket или push)
```

### Запуск агента с телефона

```
Пользователь нажимает [+Новый агент] в дашборде
  → App шлёт WebSocket фрейм: { type: "list_projects" }
  → Плагин отвечает: { type: "projects_list", projects: [...] }
  → Пользователь выбирает проект, вводит промпт, выбирает режим
  → App шлёт: { type: "launch_agent", projectPath: "...", mode: "interactive", prompt: "..." }

Плагин (интерактивный режим):
  → Открывает новую вкладку терминала в AS
  → Запускает "claude" в этой вкладке
  → Отвечает: { type: "agent_launched", tabId: 5 }
  → Начинается стриминг вывода как обычной вкладки

Плагин (batch режим):
  → Запускает subprocess: claude --print "prompt" --output-format stream-json
  → Стримит вывод фреймами agent_output
  → По завершении шлёт: { type: "agent_completed", tabId: 5, exitCode: 0 }
  → App показывает BatchResultScreen с итогом
```

### Подключение устройства

```
Запуск плагина в AS
  → Плагин стартует Ktor WS сервер на порту 8765
  → Плагин анонсирует сервис через mDNS: "_claudemobile._tcp.local"

Пользователь открывает Android App
  → App запускает NsdManager.discoverServices("_claudemobile._tcp")
  → Находит компьютер, показывает его в списке
  → Пользователь нажимает "Подключить"
  → WebSocket handshake + обмен метаданными (список вкладок, их состояния)
  → Начинается стриминг
```

---

## Протокол WebSocket (JSON фреймы)

```json
// Сервер → Клиент: начальное состояние при подключении
{ "type": "init", "tabs": [
    { "id": 1, "title": "claude-project-1", "state": "running" },
    { "id": 2, "title": "claude-project-2", "state": "waiting_input" }
]}

// Сервер → Клиент: вывод терминала
{ "type": "output", "tabId": 1, "data": "\u001b[32mRunning...\u001b[0m" }

// Клиент → Сервер: ввод пользователя
{ "type": "input", "tabId": 1, "data": "y\n" }

// Сервер → Клиент: смена состояния вкладки
{ "type": "tab_state", "tabId": 1, "state": "waiting_input", "message": "Allow tool?" }

// Сервер → Клиент: новая вкладка открыта
{ "type": "tab_added", "tab": { "id": 3, "title": "new-session", "state": "running" } }

// Сервер → Клиент: вкладка закрыта
{ "type": "tab_removed", "tabId": 2 }

// Клиент → Сервер: запрос буфера (при переключении вкладки)
{ "type": "request_buffer", "tabId": 2 }

// Сервер → Клиент: буфер (последние N строк)
{ "type": "buffer", "tabId": 2, "data": "...last 500 lines..." }

// --- Оркестрация агентов ---

// Клиент → Сервер: получить список проектов
{ "type": "list_projects" }

// Сервер → Клиент: список проектов
{ "type": "projects_list", "projects": [
    { "path": "/home/user/myapp", "name": "myapp", "hasGit": true },
    { "path": "/home/user/backend", "name": "backend", "hasGit": false }
]}

// Клиент → Сервер: запустить агента
{ "type": "launch_agent", "projectPath": "/home/user/myapp",
  "mode": "interactive", "prompt": "Add unit tests",
  "allowedTools": ["Read", "Write", "Bash"] }

// Сервер → Клиент: агент запущен
{ "type": "agent_launched", "tabId": 5, "projectPath": "/home/user/myapp", "mode": "interactive" }

// Сервер → Клиент: вывод batch агента
{ "type": "agent_output", "tabId": 5, "data": "...", "isJson": true }

// Сервер → Клиент: агент завершил работу
{ "type": "agent_completed", "tabId": 5, "exitCode": 0 }

// Клиент → Сервер: завершить агента
{ "type": "terminate_agent", "tabId": 5 }
```

---

## Технологии

| Компонент | Технология |
|-----------|-----------|
| AS Плагин | Kotlin, IntelliJ Platform SDK, Ktor (WS сервер), JmDNS |
| Android App | Kotlin, Jetpack Compose, KMP-shared модуль |
| Терминал (прототип) | WebView + xterm.js |
| Терминал (продакшн) | Compose Canvas + ANSI парсер |
| Обнаружение | mDNS: JmDNS (плагин), NsdManager (Android) |
| Push уведомления | ntfy.sh (self-hosted) или Firebase FCM |
| Оркестрация агентов | claude CLI subprocess / IntelliJ Terminal API |

---

## Файлы компонентов

- `plugin_android_studio.md` — плагин для Android Studio
- `android_app.md` — мобильное приложение
- `terminal_renderer.md` — рендеринг терминала
- `mdns_discovery.md` — обнаружение в локальной сети
- `push_notifications.md` — push-уведомления
- `agent_orchestration.md` — запуск и оркестрация агентов с телефона
